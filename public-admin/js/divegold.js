var CONFIRMATION=CONFIRMATION||{};CONFIRMATION.dom={removeCheckboxPadding:function(){$(".checkbox").parent().css("padding","0")},centralizeTableCells:function(){$("#cfTable td").css("vertical-align","middle")},subscribeSortEvent:function(){$("#cfTable").on("click","a",function(a){removeCheckboxPadding(),centralizeTableCells()})},subscribeComboEvent:function(){$(".comboOpenOperations").change(function(a){CONFIRMATION.loadReservationsOnTable()})},subscribeCheckApproveEvent:function(){$("#cfTable").on("click",".checkApprove",function(a){CONFIRMATION.changeReservationStatus(a)})},subscribeBtnConfirmOperation:function(){$("#btnConfirmOperation").click(function(){swal({title:"Deseja confirmar e fechar a operação "+$(".comboOpenOperations option:selected").text().split("-")[1]+"?",text:"Ao confirmar uma operação, todos os clientes com reservas aprovadas serão notificados da aprovação via email. Clientes com reservas pendentes serão notificados sobre o cancelamento de suas reservas.",type:"warning",showCancelButton:!0,confirmButtonColor:"rgb(44, 161, 44)",confirmButtonText:"Sim"},function(){CONFIRMATION.confirmOperation()})})},subscribeCheckDeleteReservation:function(){$(".checkDelete").on("click").each(function(){$(this).change(function(){$(".checkDelete:checked").length?$(".btnDeleteReservation").removeAttr("disabled"):$(".btnDeleteReservation").attr("disabled","")})})},subscribeDeleteReservationBtn:function(){$(".btnDeleteReservation").click(function(){CONFIRMATION.deleteReservations()})},subscribeRefreshSummaryBtn:function(){$("#btnRefreshSummary").click(function(){CONFIRMATION.showSummary()})},addDeleteButton:function(){$(".btnDeleteReservation").length||($(".dynatable-per-page").append("<button class='btn btn-danger btn-xs btn-raised btnDeleteReservation' disabled><span class='mdi-action-delete'></span></button>"),this.subscribeDeleteReservationBtn())},init:function(){this.subscribeComboEvent(),this.subscribeDetailsEvent(),this.subscribeBtnConfirmOperation(),this.centralizeTableCells(),this.subscribeRefreshSummaryBtn()}},CONFIRMATION.hbs={registerHelpers:function(){Handlebars.registerHelper("formatDate",function(a){return moment(a).format("DD/MM/YYYY")}),Handlebars.registerHelper("formatDiver",function(a){return a?"Sim":"Não"}),Handlebars.registerHelper("formatCpfCnpj",function(a){var b="";return b=11==a.length?a.substr("0","3")+"."+a.substr("3","3")+"."+a.substr("6","3")+"-"+a.substr("9","2"):a.substr("0","2")+"."+a.substr("2","3")+"."+a.substr("5","3")+"/"+a.substr("8","4")+"-"+a.substr("12","2")}),Handlebars.registerHelper("formatCelTel",function(a){var b="";return b=10==a.length?"("+a.substr("0","2")+") "+a.substr("2","4")+"-"+a.substr("6","4"):"("+a.substr("0","2")+") "+a.substr("2","5")+"-"+a.substr("7","4")})}},CONFIRMATION.deleteReservations=function(){swal({title:"Tem certeza que deseja remover esta(s) reserva(s)?",text:"Ao remover uma reserva, ela será exluída permanentemente. O responsável pela reserva será notificado sobre a reprovação da mesma.",type:"warning",showCancelButton:!0,confirmButtonColor:"rgb(44, 161, 44)",confirmButtonText:"Sim"},function(){var a=[];$(".checkDelete:checked").each(function(){var b=$(this).data("id");a.push(b)}),CONFIRMATION.fireAjaxDeleteReservations(a)})},CONFIRMATION.fireAjaxDeleteReservations=function(a){$.blockUI({message:"Excluindo reservas...",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),$.ajax({cache:!1,url:"https://reservasdivegold.com/divegold-webservice/reservation/delete",type:"POST",dataType:"text",contentType:"text/plain",data:"["+a.toString()+"]",success:function(a){$.unblockUI(),sweetAlert("Reservas deletadas com sucesso!","","success"),CONFIRMATION.loadReservationsOnTable(),CONFIRMATION.tableAfterLoad()},error:function(a){$.unblockUI(),configTimeout(a.responseJSON&&a.responseJSON.msg?a.responseJSON.msg:"Ocorreu um erro ao tentar remover uma reserva.")}})},CONFIRMATION.changeReservationStatus=function(a){swal({title:"Tem certeza que deseja alterar o status desta reserva?",text:"Modificações no status da reserva acarretam em envio de e-mails para o responsável da reserva informando a sua alteração.",type:"warning",showCancelButton:!0,confirmButtonColor:"rgb(44, 161, 44)",confirmButtonText:"Sim"},function(){return a&&a.currentTarget?($(a.currentTarget).prop("checked")?CONFIRMATION.fireAjaxChangeStatus(!1,$(a.currentTarget).data("id"),a):CONFIRMATION.fireAjaxChangeStatus(!0,$(a.currentTarget).data("id"),a),!1):void 0}),a.preventDefault()},CONFIRMATION.fireAjaxChangeStatus=function(a,b,c){var d="Aprovando reserva...",e="approve",f="Aprovada";a||(d="Cancelando reserva...",e="deny",f="Pendente"),$.blockUI({message:d,css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),$.ajax({cache:!1,url:"https://reservasdivegold.com/divegold-webservice/reservation/"+b+"/"+e,type:"POST",dataType:"json",data:"",success:function(a){$.unblockUI(),$(c.currentTarget).siblings(".statusText").text(f),"Aprovada"===f?$(c.currentTarget).prop("checked","true"):$(c.currentTarget).removeAttr("checked"),c.preventDefault()},error:function(){$.unblockUI(),c.preventDefault(),configTimeout("Ocorreu um erro ao modificar o status de uma reserva")}})},CONFIRMATION.confirmOperation=function(){var a=$(".comboOpenOperations").val();a&&$.ajax({cache:!1,url:"https://reservasdivegold.com/divegold-webservice/operation/close/"+a,type:"POST",dataType:"json",data:"",success:function(a){console.log(a),sweetAlert("Operação confirmada com sucesso!","","success"),CONFIRMATION.getOpenOperations()},error:function(){$.unblockUI(),configTimeout("Ocorreu um erro ao enviar ao salvar as operações.")}})},CONFIRMATION.showReservationDetails=function(a,b){a&&$.get("js/templates/detalhesReserva.hbs",function(b){var c=$(a).data("id");$.getJSON("https://reservasdivegold.com/divegold-webservice/reservation/"+c,function(a){var c=Handlebars.compile(b);$(".modal-body").html(c(a)),$("#cfModal").modal("show"),$(".dgTitle").focus()}).fail(function(){})},"html")},CONFIRMATION.showSummary=function(){$.get("js/templates/sumarioReservas.hbs",function(a){var b=document.getElementById("summary"),c=$(".comboOpenOperations").val();$.getJSON("https://reservasdivegold.com/divegold-webservice/operation/"+c+"/summary",function(c){var d=Handlebars.compile(a);$(b).html(d(c))}).fail(function(){})},"html")},CONFIRMATION.dom.subscribeDetailsEvent=function(){$("#cfTable").on("click","button",function(a){CONFIRMATION.showReservationDetails(a.currentTarget,a)})},CONFIRMATION.getOpenOperations=function(){$.blockUI({message:"Carregando lista de operações...",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),$.getJSON("https://reservasdivegold.com/divegold-webservice/operation/status/0",function(a){if(!a.operations)return void configTimeout("Não existem operações para geração de planilhas.");var b="<option value='{{id}}'>{{date}} - {{desc}}</option>",c=Handlebars.compile(b);$(".comboOpenOperations").html(""),$.each(a.operations,function(){var a={},b=new Date(this.date);a.id=this.id,a.desc=this.desc,a.date=b.getDate()+"/"+(b.getMonth()+1)+"/"+b.getFullYear();var d=c(a);$(".comboOpenOperations").append(d)}),$.unblockUI(),CONFIRMATION.loadReservationsOnTable()}).fail(function(){configTimeout("Ocorreu um erro ao buscar a lista de operações.")})},CONFIRMATION.loadReservationsOnTable=function(){var a=$(".comboOpenOperations").val();$.getJSON("https://reservasdivegold.com/divegold-webservice/reservation/operation/"+a,function(a){dynatableData=$("#cfTable").data("dynatable"),!dynatableData||a.reservations&&a.reservations.length?(dynatableData=$("#cfTable").dynatable({writers:{check:function(a){return"<div class='checkbox'><label><input data-id='"+a.id+"' class='checkDelete' type='checkbox'><span class='checkbox-material'><span class='check'></span></span></label></div>"},name:function(a){return a.client.name},date:function(a){return a.parsedDate=a.reservationDate,moment(a.reservationDate).format("DD/MM/YYYY    HH:mm")},tanks:function(a){return a.tanks=a.tankInfo.length,a.tankInfo?a.tankInfo.length:""},gears:function(a){return a.gearInfo?"Sim":"Não"},innNeeded:function(a){return a.innNeeded?"Sim":"Não"},status:function(a){var b=a.reservationStatus?"Aprovada":"Pendente",c=a.reservationStatus?"checked":"";return"<div class='togglebutton'><label><input type='checkbox' data-id='"+a.id+"' "+c+" class='checkApprove'><span class='toggle approveToggle'></span><span class='statusText'>"+b+"</span></label></div>"},details:function(a){return"<button data-id='"+a.id+"' class='btn btn-info btn-xs btn-raised btn-fab btnViewDetails'><span class='mdi-action-info-outline'></span></button>"}},inputs:{recordCountPageBoundTemplate:"{pageLowerBound} a {pageUpperBound} de",recordCountPageUnboundedTemplate:"{recordsShown} de",recordCountTotalTemplate:"{recordsQueryCount} {collectionName}",recordCountFilteredTemplate:" (filtrado {recordsTotal} operações)",recordCountTextTemplate:"{text} {pageTemplate} {totalTemplate} {filteredTemplate}",perPageText:"Mostrar: ",processingText:"Processando...",paginationPrev:"Anterior",paginationNext:"Próximo",recordCountText:"Exibindo "},features:{paginate:!0},dataset:{records:a.reservations}}).data("dynatable"),dynatableData.settings.dataset.originalRecords=a.reservations,dynatableData.process(),CONFIRMATION.tableAfterLoad()):(dynatableData.settings.dataset.originalRecords="",dynatableData.process(),CONFIRMATION.tableAfterLoad())}).fail(function(){})},CONFIRMATION.tableAfterLoad=function(){CONFIRMATION.dom.removeCheckboxPadding(),CONFIRMATION.dom.centralizeTableCells(),CONFIRMATION.dom.subscribeCheckApproveEvent(),CONFIRMATION.dom.subscribeCheckDeleteReservation(),CONFIRMATION.dom.addDeleteButton(),CONFIRMATION.showSummary()},CONFIRMATION.initConfirmacoes=function(){CONFIRMATION.getOpenOperations(),CONFIRMATION.dom.init(),CONFIRMATION.hbs.registerHelpers()},$(document).ready(function(){if(-1!==window.location.href.indexOf("/confirmacoes")){CONFIRMATION.initConfirmacoes()}});var initOperacoes=function(){function a(a){var b=a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear();return-1==$.inArray(b,reservedDates)?[!0,""]:[!1,"","Unavailable"]}var b="undefined"!=typeof InstallTrigger,c=!1;(!Modernizr.touch||b)&&($("#opDate").attr("type","text").datepicker({dateFormat:"dd/mm/yy",dayNames:["Domingo","Segunda","Terça","Quarta","Quinta","Sexta","Sábado"],dayNamesMin:["D","S","T","Q","Q","S","S","D"],dayNamesShort:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb","Dom"],monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],monthNamesShort:["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"],nextText:"Próximo",prevText:"Anterior",beforeShowDay:a,minDate:0,afterShow:function(a,b,c){b.dpDiv.css("width","400px"),$(".ui-datepicker").css("width",$("#opDate").width())}}),c=!0),$.getJSON("https://reservasdivegold.com/divegold-webservice/operation",function(a){$("#opTable").dynatable({writers:{date:function(a){return a.parsedDate=a.date,moment(a.date).format("DD/MM/YYYY")},status:function(a){return a.parsedStatus=a.status,a.status?"Confirmada":"Em aberto"},"delete":function(a){return"<button data-id='"+a.id+"' class='btn btn-danger btn-xs btn-raised btnRemoveOp'><span class='mdi-action-delete'></span></button>"}},inputs:{recordCountPageBoundTemplate:"{pageLowerBound} a {pageUpperBound} de",recordCountPageUnboundedTemplate:"{recordsShown} de",recordCountTotalTemplate:"{recordsQueryCount} {collectionName}",recordCountFilteredTemplate:" (filtrado {recordsTotal} operações)",recordCountTextTemplate:"{text} {pageTemplate} {totalTemplate} {filteredTemplate}",perPageText:"Mostrar: ",processingText:"Processando...",paginationPrev:"Anterior",paginationNext:"Próximo",recordCountText:"Exibindo "},features:{paginate:!0},dataset:{records:a.operations}})}).fail(function(a){console.log(a)}),$(".tableContainer").on("click","button",function(a){deleteOp(a.currentTarget,a)}),$("#btnAdicionarOp").click(function(){var a,b,d={};a=$("#opDate").val(),c?(b=a.split("/"),d.date=new Date(b[2],b[1]-1,b[0]).getTime()):(b=a.split("-"),d.date=new Date(b[0],b[1]-1,b[2]).getTime()),d.desc=$("#opName").val(),addOperation(d),$("#opDate").val(""),$("#opName").val("")})},getReservedDates=function(){$.getJSON("https://reservasdivegold.com/divegold-webservice/operation/status/0",function(a){var b=[];$.each(a.operations,function(){var a=new Date(this.date);b.push(a.getDate()+"-"+(a.getMonth()+1)+"-"+a.getFullYear())}),reservedDates=b,$("#opDate").datepicker("refresh")}).fail(function(){configTimeout("Ocorreu um erro ao buscar as datas das operações.")})},deleteOp=function(a,b){swal({title:"Tem certeza que deseja remover esta operação?",text:"Todas as reservas feitas para esta operação serão excluídas e seus responsáveis notificados por email.",type:"warning",showCancelButton:!0,confirmButtonColor:"rgb(44, 161, 44)",confirmButtonText:"Sim"},function(){b.preventDefault();var c={},d=$("#opTable").data("dynatable");c.id=$(a).data("id"),$.ajax({cache:!1,url:"https://reservasdivegold.com/divegold-webservice/operation/delete/"+c.id,type:"POST",dataType:"json",data:JSON.stringify(c),success:function(a){sweetAlert("Operação removida com sucesso!","","success"),d.settings.dataset.originalRecords=$.grep(d.settings.dataset.originalRecords,function(a,b){return a.id===c.id?!1:!0}),d.process(),getReservedDates()},error:function(a,b,c){configTimeout("Ocorreu um erro ao tentar excluir esta operação.")}})})},addOperation=function(a){return a&&a.desc&&a.date?void saveOperations(a):void configTimeout("Os campos de data e nome da operação são obrigatórios.")},saveOperations=function(a){var b,c=$("#opTable").data("dynatable"),d={};c.settings&&(b=c.settings.dataset.originalRecords,d.id=0,d.type={},d.type.id=1,d.type.desc="Livre - Mina da Passagem",d.desc=a.desc,d.date=a.date,d.status=0,$.ajax({cache:!1,url:"https://reservasdivegold.com/divegold-webservice/operation/add",type:"POST",dataType:"json",data:JSON.stringify(d),success:function(a){c.settings.dataset.originalRecords.push(a),c.process(),sweetAlert("Operações salvas com sucesso!","","success"),getReservedDates()},error:function(){$.unblockUI(),configTimeout("Ocorreu um erro ao enviar ao salvar as operações.")}}))};$(document).ready(function(){if(-1!==window.location.href.indexOf("/operacoes")){getReservedDates(),initOperacoes()}});var getOperations=function(){$.blockUI({message:"Carregando lista de operações...",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),$.getJSON("https://reservasdivegold.com/divegold-webservice/operation/status/1",function(a){if(!a.operations)return void configTimeout("Não existem operações para geração de planilhas.");var b="<option value='{{id}}'>{{date}} - {{desc}}</option>",c=Handlebars.compile(b);$.each(a.operations,function(){var a={},b=new Date(this.date);a.id=this.id,a.desc=this.desc,a.date=b.getDate()+"/"+(b.getMonth()+1)+"/"+b.getFullYear();var d=c(a);$(".comboOperacoes").append(d)}),$.unblockUI()}).fail(function(){configTimeout("Ocorreu um erro ao buscar a lista de operações.")})},generate=function(){var a=$(".comboOperacoes option:selected").val();a?($.blockUI({message:"Processando...",css:{border:"none",padding:"15px",backgroundColor:"#000","-webkit-border-radius":"10px","-moz-border-radius":"10px",opacity:.5,color:"#fff"}}),$.getJSON("https://reservasdivegold.com/divegold-webservice/operation/artifacts/"+a,function(a){$.unblockUI(),sweetAlert(a.msg,"","success")}).fail(function(a){$.unblockUI(),configTimeout(a.responseJSON.msg)})):configTimeout("Favor escolha uma operação.")},initPlanilha=function(){var a=this;$("#btnGenerate").click(function(){swal({title:"Deseja criar as Planilhas para a operação: "+$(".comboOperacoes option:selected").text().split("-")[1]+"?",text:"Ao confirmar, as planilhas serão encaminhadas em formato excel para o email reservas.divegold@gmail.com",type:"warning",showCancelButton:!0,confirmButtonColor:"rgb(44, 161, 44)",confirmButtonText:"Sim"},function(){a.generate()})})};$(document).ready(function(){-1!==window.location.href.indexOf("/planilha")&&(initPlanilha(),getOperations())});